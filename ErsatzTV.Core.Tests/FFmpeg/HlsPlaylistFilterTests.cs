using ErsatzTV.Core.FFmpeg;
using ErsatzTV.Core.Interfaces.FFmpeg;
using ErsatzTV.FFmpeg.OutputFormat;
using Microsoft.Extensions.Logging;
using NSubstitute;
using NUnit.Framework;
using Shouldly;

namespace ErsatzTV.Core.Tests.FFmpeg;

[TestFixture]
public class HlsPlaylistFilterTests
{
    [SetUp]
    public void SetUp() =>
        _hlsPlaylistFilter = new HlsPlaylistFilter(
            Substitute.For<ITempFilePool>(),
            Substitute.For<ILogger<HlsPlaylistFilter>>()
        );

    private HlsPlaylistFilter _hlsPlaylistFilter;

    [Test]
    public void HlsPlaylistFilter_ShouldRewriteProgramDateTime()
    {
        var start = new DateTimeOffset(2021, 10, 9, 8, 0, 0, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:49.320-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:53.320-0500
live_1760874038_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:57.320-0500
live_1760874038_001139.m4s").Split(Environment.NewLine);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 1
            },
            OutputFormatKind.HlsMp4,
            start,
            start.AddSeconds(-30),
            new FakeHlsInitSegmentCache(),
            input,
            maybeMaxSegments: 10);

        result.PlaylistStart.ShouldBe(start);
        result.Sequence.ShouldBe(1137);
        result.Playlist.ShouldBe(
            NormalizeLineEndings(
                @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:00.000-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:04.000-0500
live_1760874038_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:08.000-0500
live_1760874038_001139.m4s
"));
    }

    [Test]
    public void HlsPlaylistFilter_ShouldLimitSegments()
    {
        var start = new DateTimeOffset(2021, 10, 9, 8, 0, 0, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:49.320-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:53.320-0500
live_1760874038_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:57.320-0500
live_1760874038_001139.m4s").Split(Environment.NewLine);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 1
            },
            OutputFormatKind.HlsMp4,
            start,
            start.AddSeconds(-30),
            new FakeHlsInitSegmentCache(),
            input,
            2);

        result.PlaylistStart.ShouldBe(start);
        result.Sequence.ShouldBe(1137);
        result.Playlist.ShouldBe(
            NormalizeLineEndings(
                @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:00.000-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:04.000-0500
live_1760874038_001138.m4s
"));
    }

    [Test]
    public void HlsPlaylistFilter_ShouldAddDiscontinuity()
    {
        var start = new DateTimeOffset(2021, 10, 9, 8, 0, 0, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:49.320-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:53.320-0500
live_1760874038_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:57.320-0500
live_1760874038_001139.m4s").Split(Environment.NewLine);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylistWithDiscontinuity(
            new Dictionary<long, int>
            {
                [1760874038] = 1
            },
            OutputFormatKind.HlsMp4,
            start,
            start.AddSeconds(-30),
            new FakeHlsInitSegmentCache(),
            input);

        result.PlaylistStart.ShouldBe(start);
        result.Sequence.ShouldBe(1137);
        result.Playlist.ShouldBe(
            NormalizeLineEndings(
                @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:00.000-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:04.000-0500
live_1760874038_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:08.000-0500
live_1760874038_001139.m4s
#EXT-X-DISCONTINUITY
"));
    }

    [Test]
    public void HlsPlaylistFilter_ShouldFilterOldSegmentsBeyondMax()
    {
        var start = new DateTimeOffset(2021, 10, 9, 8, 0, 0, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:49.320-0500
live_1760874038_001137.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:53.320-0500
live_1760874038_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:57.320-0500
live_1760874038_001139.m4s").Split(Environment.NewLine);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 1
            },
            OutputFormatKind.HlsMp4,
            start,
            start.AddSeconds(6),
            new FakeHlsInitSegmentCache(),
            input,
            1);

        result.PlaylistStart.ShouldBe(start.AddSeconds(8));
        result.Sequence.ShouldBe(1139);
        result.Playlist.ShouldBe(
            NormalizeLineEndings(
                @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1139
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:08.000-0500
live_1760874038_001139.m4s
"));
    }

    [Test]
    public void HlsPlaylistFilter_ShouldKeepOldDiscontinuity()
    {
        var start = new DateTimeOffset(2021, 10, 9, 8, 0, 0, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:49.320-0500
live_1760874038_001137.m4s
#EXT-X-DISCONTINUITY
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:53.320-0500
live_1760874042_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-08T08:34:57.320-0500
live_1760874042_001139.m4s").Split(Environment.NewLine);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 1,
                [1760874042] = 2
            },
            OutputFormatKind.HlsMp4,
            start,
            start.AddSeconds(6),
            new FakeHlsInitSegmentCache(),
            input,
            maybeMaxSegments: 10);

        result.PlaylistStart.ShouldBe(start);
        result.Sequence.ShouldBe(1137);
        result.Playlist.ShouldBe(
            NormalizeLineEndings(
                @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:1137
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:00.000-0500
live_1760874038_001137.m4s
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874042_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:04.000-0500
live_1760874042_001138.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2021-10-09T08:00:08.000-0500
live_1760874042_001139.m4s
"));
    }

    [Test]
    public void HlsPlaylistFilter_Should_Increment_DiscontinuityCount()
    {
        var start = new DateTimeOffset(2022, 5, 25, 20, 8, 0, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:08:55.981-0500
live_1760874038_000000.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:08:59.985-0500
live_1760874038_000001.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:03.989-0500
live_1760874038_000002.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:07.993-0500
live_1760874038_000003.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:11.997-0500
live_1760874038_000004.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:16.001-0500
live_1760874038_000005.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:20.005-0500
live_1760874038_000006.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:24.009-0500
live_1760874038_000007.m4s
#EXTINF:3.970633,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:28.013-0500
live_1760874038_000008.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:31.983-0500
live_1760874038_000009.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:35.987-0500
live_1760874038_000010.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:39.991-0500
live_1760874038_000011.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:43.995-0500
live_1760874038_000012.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:47.999-0500
live_1760874038_000013.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:52.003-0500
live_1760874038_000014.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:09:56.007-0500
live_1760874038_000015.m4s
#EXTINF:3.970633,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:00.011-0500
live_1760874038_000016.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:03.982-0500
live_1760874038_000017.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:07.986-0500
live_1760874038_000018.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:11.990-0500
live_1760874038_000019.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:15.994-0500
live_1760874038_000020.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:19.998-0500
live_1760874038_000021.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:24.002-0500
live_1760874038_000022.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:28.006-0500
live_1760874038_000023.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:32.010-0500
live_1760874038_000024.m4s
#EXTINF:3.970633,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:36.014-0500
live_1760874038_000025.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:39.985-0500
live_1760874038_000026.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:43.989-0500
live_1760874038_000027.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:47.993-0500
live_1760874038_000028.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:51.997-0500
live_1760874038_000029.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:10:56.001-0500
live_1760874038_000030.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:00.005-0500
live_1760874038_000031.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:04.009-0500
live_1760874038_000032.m4s
#EXTINF:3.970633,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:08.013-0500
live_1760874038_000033.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:11.983-0500
live_1760874038_000034.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:15.987-0500
live_1760874038_000035.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:19.991-0500
live_1760874038_000036.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:23.995-0500
live_1760874038_000037.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:27.999-0500
live_1760874038_000038.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:32.003-0500
live_1760874038_000039.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:36.007-0500
live_1760874038_000040.m4s
#EXTINF:3.970633,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:40.011-0500
live_1760874038_000041.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:43.982-0500
live_1760874038_000042.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:47.986-0500
live_1760874038_000043.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:51.990-0500
live_1760874038_000044.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:55.994-0500
live_1760874038_000045.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:59.998-0500
live_1760874038_000046.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:04.002-0500
live_1760874038_000047.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:08.006-0500
live_1760874038_000048.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:12.010-0500
live_1760874038_000049.m4s
#EXTINF:3.970633,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:16.014-0500
live_1760874038_000050.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:19.985-0500
live_1760874038_000051.m4s
#EXTINF:0.433767,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:23.989-0500
live_1760874038_000052.m4s
#EXT-X-DISCONTINUITY
#EXT-X-MAP:URI=""1760874138_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:30.007-0500
live_1760874138_000053.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:34.007-0500
live_1760874138_000054.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:38.007-0500
live_1760874138_000055.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:42.007-0500
live_1760874138_000056.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:46.007-0500
live_1760874138_000057.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:50.007-0500
live_1760874138_000058.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:54.007-0500
live_1760874138_000059.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:58.007-0500
live_1760874138_000060.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:02.007-0500
live_1760874138_000061.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:06.007-0500
live_1760874138_000062.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:10.007-0500
live_1760874138_000063.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:14.007-0500
live_1760874138_000064.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:18.007-0500
live_1760874138_000065.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:22.007-0500
live_1760874138_000066.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:26.007-0500
live_1760874138_000067.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:30.007-0500
live_1760874138_000068.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:34.007-0500
live_1760874138_000069.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:38.007-0500
live_1760874138_000070.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:42.007-0500
live_1760874138_000071.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:46.007-0500
live_1760874138_000072.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:50.007-0500
live_1760874138_000073.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:54.007-0500
live_1760874138_000074.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:58.007-0500
live_1760874138_000075.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:02.007-0500
live_1760874138_000076.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:06.007-0500
live_1760874138_000077.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:10.007-0500
live_1760874138_000078.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:14.007-0500
live_1760874138_000079.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:18.007-0500
live_1760874138_000080.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:22.007-0500
live_1760874138_000081.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:13:26.007-0500
live_1760874138_000082.m4s").Split(Environment.NewLine);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 1,
                [1760874138] = 2
            },
            OutputFormatKind.HlsMp4,
            start,
            start.AddSeconds(220),
            new FakeHlsInitSegmentCache(),
            input,
            maybeMaxSegments: 10);

        // result.PlaylistStart.ShouldBe(start);
        result.Sequence.ShouldBe(56);
        result.Playlist.ShouldBe(
            NormalizeLineEndings(
                @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:56
#EXT-X-DISCONTINUITY-SEQUENCE:2
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760874138_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:40.441-0500
live_1760874138_000056.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:44.441-0500
live_1760874138_000057.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:48.441-0500
live_1760874138_000058.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:52.441-0500
live_1760874138_000059.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:11:56.441-0500
live_1760874138_000060.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:00.441-0500
live_1760874138_000061.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:04.441-0500
live_1760874138_000062.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:08.441-0500
live_1760874138_000063.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:12.441-0500
live_1760874138_000064.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2022-05-25T20:12:16.441-0500
live_1760874138_000065.m4s
"));
    }

    [Test]
    public void HlsPlaylistFilter_ShouldHandleDiscontinuitySequenceOnSegmentRemoval()
    {
        var start = new DateTimeOffset(2025, 9, 17, 10, 11, 5, 31, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:46
#EXT-X-DISCONTINUITY-SEQUENCE:2
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:1.734000,
#EXT-X-PROGRAM-DATE-TIME:2025-09-17T10:11:05.031-0500
live_1760874038_000046.m4s
#EXT-X-DISCONTINUITY
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2025-09-17T10:11:06.765-0500
live_1760874040_000047.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2025-09-17T10:11:10.769-0500
live_1760874040_000048.m4s
").Split(Environment.NewLine);

        // filter 'live000046.m4s'
        var filterBefore = start.AddSeconds(2);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 2,
                [1760874040] = 3
            },
            OutputFormatKind.HlsMp4,
            start,
            filterBefore,
            new FakeHlsInitSegmentCache(),
            input,
            2);

        result.Sequence.ShouldBe(47);

        string expectedPlaylist = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:4
#EXT-X-MEDIA-SEQUENCE:47
#EXT-X-DISCONTINUITY-SEQUENCE:3
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760874040_init.mp4""
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2025-09-17T10:11:06.765-0500
live_1760874040_000047.m4s
#EXTINF:4.004000,
#EXT-X-PROGRAM-DATE-TIME:2025-09-17T10:11:10.769-0500
live_1760874040_000048.m4s
");

        result.Playlist.ShouldBe(expectedPlaylist);
    }

    [Test]
    public void HlsPlaylistFilter_ShouldNotPullDiscontinuityForward()
    {
        // #EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:59.132-0500
        var start = new DateTimeOffset(2025, 10, 19, 6, 42, 27, 132, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"##EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:5
#EXT-X-MEDIA-SEQUENCE:38
#EXT-X-DISCONTINUITY-SEQUENCE:2
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760873994_init.mp4""
#EXTINF:3.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:27.132-0500
live_1760874038_000038.m4s
#EXTINF:5.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:30.132-0500
live_1760874038_000039.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:35.132-0500
live_1760874038_000040.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:39.132-0500
live_1760874038_000041.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:43.132-0500
live_1760874038_000042.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:47.132-0500
live_1760874038_000043.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:51.132-0500
live_1760874038_000044.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:55.132-0500
live_1760874038_000045.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:59.132-0500
live_1760874038_000046.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:03.132-0500
live_1760874038_000047.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:07.132-0500
live_1760874038_000048.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:11.132-0500
live_1760874038_000049.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:15.132-0500
live_1760874038_000050.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:19.132-0500
live_1760874038_000051.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:23.132-0500
live_1760874038_000052.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:27.132-0500
live_1760874038_000053.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:31.132-0500
live_1760874038_000054.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:35.132-0500
live_1760874038_000055.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:39.132-0500
live_1760874038_000056.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:43.132-0500
live_1760874038_000057.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:47.132-0500
live_1760874038_000058.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:51.132-0500
live_1760874038_000059.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:55.132-0500
live_1760874038_000060.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:59.132-0500
live_1760874038_000061.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:44:03.132-0500
live_1760874038_000062.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:44:07.132-0500
live_1760874038_000063.m4s
#EXTINF:1.720000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:44:11.132-0500
live_1760874038_000064.m4s
#EXT-X-DISCONTINUITY
").Split(Environment.NewLine);

        // filter 'live000046.m4s'
        var filterBefore = start.AddSeconds(32);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 2
            },
            OutputFormatKind.HlsMp4,
            start,
            filterBefore,
            new FakeHlsInitSegmentCache(),
            input,
            10);

        result.Sequence.ShouldBe(46);

        string expectedPlaylist = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:5
#EXT-X-MEDIA-SEQUENCE:46
#EXT-X-DISCONTINUITY-SEQUENCE:2
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:59.132-0500
live_1760874038_000046.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:03.132-0500
live_1760874038_000047.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:07.132-0500
live_1760874038_000048.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:11.132-0500
live_1760874038_000049.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:15.132-0500
live_1760874038_000050.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:19.132-0500
live_1760874038_000051.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:23.132-0500
live_1760874038_000052.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:27.132-0500
live_1760874038_000053.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:31.132-0500
live_1760874038_000054.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:35.132-0500
live_1760874038_000055.m4s
");

        result.Playlist.ShouldBe(expectedPlaylist);
    }

    [Test]
    public void HlsPlaylistFilter_ShouldNotPullDiscontinuityForward_PartTwo()
    {
        // #EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:03.132-0500
        var start = new DateTimeOffset(2025, 10, 19, 6, 42, 27, 132, TimeSpan.FromHours(-5));
        string[] input = NormalizeLineEndings(
            @"##EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:5
#EXT-X-MEDIA-SEQUENCE:38
#EXT-X-DISCONTINUITY-SEQUENCE:2
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760873994_init.mp4""
#EXTINF:3.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:27.132-0500
live_1760874038_000038.m4s
#EXTINF:5.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:30.132-0500
live_1760874038_000039.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:35.132-0500
live_1760874038_000040.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:39.132-0500
live_1760874038_000041.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:43.132-0500
live_1760874038_000042.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:47.132-0500
live_1760874038_000043.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:51.132-0500
live_1760874038_000044.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:55.132-0500
live_1760874038_000045.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:42:59.132-0500
live_1760874038_000046.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:03.132-0500
live_1760874038_000047.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:07.132-0500
live_1760874038_000048.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:11.132-0500
live_1760874038_000049.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:15.132-0500
live_1760874038_000050.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:19.132-0500
live_1760874038_000051.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:23.132-0500
live_1760874038_000052.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:27.132-0500
live_1760874038_000053.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:31.132-0500
live_1760874038_000054.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:35.132-0500
live_1760874038_000055.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:39.132-0500
live_1760874038_000056.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:43.132-0500
live_1760874038_000057.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:47.132-0500
live_1760874038_000058.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:51.132-0500
live_1760874038_000059.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:55.132-0500
live_1760874038_000060.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:59.132-0500
live_1760874038_000061.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:44:03.132-0500
live_1760874038_000062.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:44:07.132-0500
live_1760874038_000063.m4s
#EXTINF:1.720000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:44:11.132-0500
live_1760874038_000064.m4s
#EXT-X-DISCONTINUITY
").Split(Environment.NewLine);

        // filter 'live000046.m4s'
        var filterBefore = start.AddSeconds(36);

        TrimPlaylistResult result = _hlsPlaylistFilter.TrimPlaylist(
            new Dictionary<long, int>
            {
                [1760874038] = 2
            },
            OutputFormatKind.HlsMp4,
            start,
            filterBefore,
            new FakeHlsInitSegmentCache(),
            input,
            10);

        result.Sequence.ShouldBe(47);

        string expectedPlaylist = NormalizeLineEndings(
            @"#EXTM3U
#EXT-X-VERSION:7
#EXT-X-TARGETDURATION:5
#EXT-X-MEDIA-SEQUENCE:47
#EXT-X-DISCONTINUITY-SEQUENCE:2
#EXT-X-INDEPENDENT-SEGMENTS
#EXT-X-MAP:URI=""1760874038_init.mp4""
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:03.132-0500
live_1760874038_000047.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:07.132-0500
live_1760874038_000048.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:11.132-0500
live_1760874038_000049.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:15.132-0500
live_1760874038_000050.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:19.132-0500
live_1760874038_000051.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:23.132-0500
live_1760874038_000052.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:27.132-0500
live_1760874038_000053.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:31.132-0500
live_1760874038_000054.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:35.132-0500
live_1760874038_000055.m4s
#EXTINF:4.000000,
#EXT-X-PROGRAM-DATE-TIME:2025-10-19T06:43:39.132-0500
live_1760874038_000056.m4s
");

        result.Playlist.ShouldBe(expectedPlaylist);
    }

    private static string NormalizeLineEndings(string str) =>
        str
            .Replace("\r\n", "\n")
            .Replace("\r", "\n")
            .Replace("\n", Environment.NewLine);

    private class FakeHlsInitSegmentCache : IHlsInitSegmentCache
    {
        public Task AddSegment(string segment) => throw new NotSupportedException();

        public string EarliestSegmentByHash(long generatedAt) => $"{generatedAt}_init.mp4";

        public bool IsEarliestByHash(string fileName) => throw new NotSupportedException();

        public void DeleteSegment(string segment) => throw new NotSupportedException();
    }
}
